tmp:
	npm run build
#	./node_modules/.bin/tape test/keyMode-test.js
#	./node_modules/.bin/tape test/transition-test.js
	./node_modules/.bin/tape test/zoom-test.js

main: test-one-by-one

test-one-by-one:
	npm run build; \
	set -e; \
	for t in test/*test.js; do \
	echo TEST: $$t; \
	set -e; \
	./node_modules/.bin/tape $$t; \
	done

src/wasmCode.js:
	bin/genWasmCode.py > $@

public: tag push-tag npm-build npm-publish
#public: push-tag npm-build npm-publish

tag:
	tag=v`grep -m1 '^ *"version": *".*", *$$' package.json | sed 's/.*:[^"]*"\(.*\)", *$$/\1/'`; \
	git tag $$tag

push-tag: push
	git push origin `git rev-parse --abbrev-ref HEAD`:`git tag -l | grep '^v[0-9]*\.[0-9]*\.[0-9]*$$' | tail -1`

push:
	git push origin `git rev-parse --abbrev-ref HEAD`

DIR=/tmp/d3-graphviz-npm

npm-build:
	dir=`pwd`; rm -rf $(DIR); mkdir -p $(DIR); cd $(DIR); git clone $$dir/.git; cd d3-graphviz; npm install

npm-test: npm-build
	cd $(DIR)/d3-graphviz; npm test

npm-publish-dry-run: DRY_RUN=--dry-run
npm-publish-dry-run: npm-publish


# NOTE: the tag used here is not the version. It's a possible suffix, e.g. alpha.1
npm-publish:
	tag=`grep -m1 '^ *"version": *".*-.*", *$$' package.json | sed 's/[^-]*-\(.*\)", *$$/\1/'`; \
	tag=$${tag:+--tag $$tag}; \
	cd $(DIR)/d3-graphviz; npm publish $(DRY_RUN) $$tag; \
	echo "Published $$tag"

readme: FORCE
	npx marked README.md >readme.html

changelog: changelog.html

changelog.html: CHANGELOG.md
	npx marked CHANGELOG.md >changelog.html
serve:
	http-server

clean:
	rm -rf build dist

.PHONY: FORCE
